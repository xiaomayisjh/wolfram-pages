<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolfram|Alpha - 增强版客户端</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --wolfram-orange: #FF6600;
            --wolfram-blue: #0066CC;
            --wolfram-dark-blue: #003366;
            --wolfram-light-blue: #E6F2FF;
            --wolfram-gray: #F5F5F5;
            --wolfram-text: #333333;
            --wolfram-border: #E0E0E0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: var(--wolfram-text);
            line-height: 1.6;
        }

        .wolfram-header {
            background: linear-gradient(135deg, var(--wolfram-orange) 0%, #FF8533 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .search-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .search-container:focus-within {
            border-color: var(--wolfram-orange);
            box-shadow: 0 8px 40px rgba(255,102,0,0.2);
            transform: translateY(-2px);
        }

        .pod-container {
            background: white;
            border: 1px solid var(--wolfram-border);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .pod-container:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-4px);
        }

        .pod-header {
            background: var(--wolfram-gray);
            border-bottom: 1px solid var(--wolfram-border);
            padding: 16px 20px;
            font-weight: 600;
            color: var(--wolfram-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pod-content {
            padding: 20px;
        }

        .pod-primary {
            border-left: 5px solid var(--wolfram-orange);
            box-shadow: 0 4px 16px rgba(255,102,0,0.15);
        }

        .pod-primary .pod-header {
            background: linear-gradient(135deg, #FFF5F0 0%, #FFE8D6 100%);
            color: var(--wolfram-orange);
            font-weight: 700;
        }

        .math-display {
            font-family: 'Times New Roman', serif;
            font-size: 1.3em;
            text-align: center;
            padding: 20px;
            background: var(--wolfram-light-blue);
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid rgba(0,102,204,0.2);
        }

        .assumption-container {
            background: #FFFBEB;
            border: 1px solid #FDE68A;
            border-left: 4px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .assumption-item {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .assumption-item:hover {
            background: #F3F4F6;
            border-color: var(--wolfram-orange);
            transform: translateX(4px);
        }

        .step-container {
            background: linear-gradient(135deg, #F0F8FF 0%, #E6F2FF 100%);
            border-left: 4px solid var(--wolfram-blue);
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }

        .step-item {
            padding: 16px 0;
            border-bottom: 1px solid rgba(0,102,204,0.2);
            position: relative;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-number {
            background: var(--wolfram-blue);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
        }

        .loading-animation {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,102,0,0.3);
            border-radius: 50%;
            border-top-color: var(--wolfram-orange);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 16px 0;
            transition: transform 0.3s ease;
        }

        .result-image:hover {
            transform: scale(1.02);
        }

        .interactive-element {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            padding: 2px 6px;
        }

        .interactive-element:hover {
            background: rgba(255,102,0,0.1);
            color: var(--wolfram-orange);
        }

        .suggestion-item {
            background: white;
            border: 1px solid var(--wolfram-border);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .suggestion-item:hover {
            background: var(--wolfram-light-blue);
            border-color: var(--wolfram-blue);
            transform: translateX(4px);
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F3F4F6;
        }

        .history-item:hover {
            background: var(--wolfram-gray);
            transform: translateX(4px);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .error-container {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            border-left: 4px solid #EF4444;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .warning-container {
            background: #FFFBEB;
            border: 1px solid #FDE68A;
            border-left: 4px solid #F59E0B;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .tips-container {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            border-left: 4px solid #10B981;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--wolfram-orange);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(255,102,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255,102,0,0.4);
        }

        .modal {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .tab-button {
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tab-button.active {
            background: var(--wolfram-orange);
            color: white;
        }

        .tab-button:not(.active):hover {
            background: var(--wolfram-gray);
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .pod-container {
                margin-bottom: 16px;
            }
            .pod-content {
                padding: 16px;
            }
            .floating-button {
                bottom: 16px;
                right: 16px;
                width: 48px;
                height: 48px;
            }
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--wolfram-gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--wolfram-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #CCCCCC;
        }
    </style>

    <script>
        // MathJax配置
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="wolfram-header shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold">Wolfram|Alpha</h1>
                    <span class="ml-3 text-sm bg-white bg-opacity-20 px-2 py-1 rounded">Enhanced</span>
                </div>
                <div class="flex items-center space-x-6">
                    <button id="settingsBtn" class="hover:text-orange-200 transition-colors">
                        <i class="fas fa-cog mr-1"></i>设置
                    </button>
                    <button id="helpBtn" class="hover:text-orange-200 transition-colors">
                        <i class="fas fa-question-circle mr-1"></i>帮助
                    </button>
                    <div class="relative">
                        <button id="apiStatusBtn" class="flex items-center hover:text-orange-200 transition-colors">
                            <div id="apiStatusIndicator" class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <span id="apiStatusText">在线</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 搜索区域 -->
        <div class="text-center mb-12">
            <h2 class="text-5xl font-bold text-gray-900 mb-4">计算型知识引擎</h2>
            <p class="text-xl text-gray-600 mb-8">连接增强API服务器，获得更强大的计算能力</p>
            
            <div class="search-container max-w-5xl mx-auto p-6">
                <div class="flex items-center mb-4">
                    <input 
                        type="text" 
                        id="queryInput" 
                        placeholder="例如：solve x^2 + 3x + 2 = 0, step-by-step derivative of sin(x), plot x^2..."
                        class="flex-1 text-lg px-6 py-4 border-none outline-none bg-transparent"
                        autocomplete="off"
                    >
                    <button 
                        id="searchBtn" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-4 rounded-lg font-semibold transition-colors flex items-center ml-4"
                    >
                        <i class="fas fa-search mr-2"></i>
                        计算
                    </button>
                    <button 
                        id="clearBtn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-4 rounded-lg font-semibold transition-colors flex items-center ml-2 hidden"
                        title="清除所有结果"
                    >
                        <i class="fas fa-trash mr-2"></i>
                        清除
                    </button>
                </div>
                
                <!-- 高级选项 -->
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="stepByStepMode" class="mr-2">
                            <span>逐步解决</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="plotMode" class="mr-2">
                            <span>生成图表</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="validateMode" class="mr-2">
                            <span>验证查询</span>
                        </label>
                    </div>
                    <button id="advancedOptionsBtn" class="text-orange-600 hover:text-orange-700">
                        <i class="fas fa-cog mr-1"></i>高级选项
                    </button>
                </div>
                
                <!-- 搜索建议 -->
                <div id="suggestions" class="hidden mt-6 text-left">
                    <div class="text-sm text-gray-600 mb-3">搜索建议：</div>
                    <div id="suggestionsList" class="space-y-2"></div>
                </div>
            </div>

            <!-- 快速示例 -->
            <div class="mt-8 flex flex-wrap justify-center gap-3">
                <button class="example-btn bg-blue-100 text-blue-800 px-6 py-3 rounded-full hover:bg-blue-200 transition-colors" data-query="2+2" data-mode="normal">
                    <i class="fas fa-plus mr-2"></i>简单测试
                </button>
                <button class="example-btn bg-green-100 text-green-800 px-6 py-3 rounded-full hover:bg-green-200 transition-colors" data-query="solve x^2+5x+6=0" data-mode="stepbystep">
                    <i class="fas fa-calculator mr-2"></i>方程求解
                </button>
                <button class="example-btn bg-purple-100 text-purple-800 px-6 py-3 rounded-full hover:bg-purple-200 transition-colors" data-query="derivative of sin(x)*cos(x)" data-mode="stepbystep">
                    <i class="fas fa-function mr-2"></i>微积分
                </button>
                <button class="example-btn bg-red-100 text-red-800 px-6 py-3 rounded-full hover:bg-red-200 transition-colors" data-query="plot sin(x) from -pi to pi" data-mode="plot">
                    <i class="fas fa-chart-line mr-2"></i>函数图像
                </button>
                <button class="example-btn bg-yellow-100 text-yellow-800 px-6 py-3 rounded-full hover:bg-yellow-200 transition-colors" data-query="H2O" data-mode="normal">
                    <i class="fas fa-atom mr-2"></i>化学查询
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loadingContainer" class="hidden text-center py-12">
            <div class="loading-animation mx-auto mb-6"></div>
            <p class="text-gray-600 text-lg">正在处理您的查询...</p>
            <p class="text-gray-500 text-sm mt-2">连接到增强API服务器</p>
        </div>

        <!-- 结果区域 -->
        <div id="resultsContainer" class="space-y-6">
            <!-- 欢迎界面 -->
            <div class="text-center py-16">
                <div class="mb-8">
                    <i class="fas fa-rocket text-6xl text-orange-500 mb-4"></i>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4">欢迎使用 Wolfram|Alpha Enhanced</h3>
                    <p class="text-gray-600 text-lg mb-6">连接到增强API服务器，体验更强大的计算功能</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <i class="fas fa-brain text-3xl text-blue-500 mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">智能解析</h4>
                        <p class="text-gray-600">自动识别查询类型，提供最相关的结果</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <i class="fas fa-step-forward text-3xl text-green-500 mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">逐步解决</h4>
                        <p class="text-gray-600">详细的解题步骤，帮助理解计算过程</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <i class="fas fa-chart-line text-3xl text-purple-500 mb-4"></i>
                        <h4 class="text-xl font-semibold mb-2">可视化</h4>
                        <p class="text-gray-600">生成图表和图像，直观展示结果</p>
                    </div>
                </div>
                
                <div class="mt-8 text-sm text-gray-500">
                    <p><i class="fas fa-keyboard mr-2"></i>快捷键：Ctrl+K 快速搜索 | Ctrl+H 查看历史</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 浮动按钮 -->
    <div class="floating-button" id="historyBtn" title="查询历史">
        <i class="fas fa-history text-xl"></i>
    </div>

    <!-- 历史记录模态框 -->
    <div id="historyModal" class="hidden fixed inset-0 modal z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content max-w-2xl w-full max-h-96 overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">查询历史</h3>
                        <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="historyList" class="p-6 max-h-80 overflow-y-auto">
                    <!-- 历史记录将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 高级选项模态框 -->
    <div id="advancedModal" class="hidden fixed inset-0 modal z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content max-w-4xl w-full">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold">高级选项</h3>
                        <button id="closeAdvancedModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-3">输出格式</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="format" value="plaintext,image" checked class="mr-2">
                                    <span>文本 + 图像</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="format" value="plaintext" class="mr-2">
                                    <span>仅文本</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="format" value="image" class="mr-2">
                                    <span>仅图像</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-3">单位系统</h4>
                            <select id="unitsSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">默认</option>
                                <option value="metric">公制</option>
                                <option value="imperial">英制</option>
                            </select>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-3">图像宽度</h4>
                            <input type="range" id="widthSlider" min="200" max="800" value="400" class="w-full">
                            <div class="text-sm text-gray-600 mt-1">
                                <span id="widthValue">400</span> 像素
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-3">位置信息</h4>
                            <input type="text" id="locationInput" placeholder="例如：Beijing, China" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="resetAdvanced" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                            重置
                        </button>
                        <button id="applyAdvanced" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                            应用
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局配置
        const API_CONFIG = {
            baseUrl: 'http://localhost:5000',
            endpoints: {
                query: '/api/query',
                simple: '/api/simple',
                validate: '/api/validate',
                stepbystep: '/api/stepbystep',
                plot: '/api/plot',
                suggestions: '/api/suggestions',
                health: '/health'
            }
        };

        // 全局变量
        let queryHistory = JSON.parse(localStorage.getItem('wolframHistoryEnhanced') || '[]');
        let currentQuery = '';
        let apiStatus = 'unknown';

        // DOM元素
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const suggestions = document.getElementById('suggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const advancedModal = document.getElementById('advancedModal');

        // 工具函数
        class WolframEnhancedClient {
            constructor() {
                this.checkApiStatus();
                setInterval(() => this.checkApiStatus(), 30000); // 每30秒检查一次API状态
            }

            async checkApiStatus() {
                try {
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.health}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.updateApiStatus('online', data.status);
                    } else {
                        this.updateApiStatus('offline', 'API服务器离线');
                    }
                } catch (error) {
                    this.updateApiStatus('error', '连接错误');
                }
            }

            updateApiStatus(status, message) {
                apiStatus = status;
                const indicator = document.getElementById('apiStatusIndicator');
                const text = document.getElementById('apiStatusText');
                
                switch(status) {
                    case 'online':
                        indicator.className = 'w-2 h-2 bg-green-400 rounded-full mr-2';
                        text.textContent = '在线';
                        break;
                    case 'offline':
                        indicator.className = 'w-2 h-2 bg-red-400 rounded-full mr-2';
                        text.textContent = '离线';
                        break;
                    case 'error':
                        indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full mr-2';
                        text.textContent = '错误';
                        break;
                }
            }

            async makeRequest(endpoint, data = null, method = 'GET') {
                const url = `${API_CONFIG.baseUrl}${endpoint}`;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                console.log(`发送${method}请求到:`, url);
                if (data) console.log('请求数据:', data);

                try {
                    const response = await fetch(url, options);
                    console.log('HTTP响应状态:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    console.log('响应内容类型:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const result = await response.json();
                        console.log('解析的JSON响应:', result);
                        return result;
                    } else {
                        const text = await response.text();
                        console.log('文本响应:', text);
                        // 尝试解析为JSON
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            return { success: false, error: '服务器返回了非JSON格式的响应', raw: text };
                        }
                    }
                } catch (error) {
                    console.error('请求失败:', error);
                    throw new Error(`API请求失败: ${error.message}`);
                }
            }

            async query(input, options = {}) {
                const data = {
                    input: input,
                    format: options.format || 'plaintext,image',
                    output: 'json',
                    ...options
                };

                return await this.makeRequest(API_CONFIG.endpoints.query, data, 'POST');
            }

            async validateQuery(input) {
                return await this.makeRequest(API_CONFIG.endpoints.validate, { input }, 'POST');
            }

            async getStepByStep(input) {
                return await this.makeRequest(API_CONFIG.endpoints.stepbystep, { input }, 'POST');
            }

            async getPlot(input, width = 400, height = 300) {
                return await this.makeRequest(API_CONFIG.endpoints.plot, { input, width, height }, 'POST');
            }

            async getSuggestions(input) {
                return await this.makeRequest(`${API_CONFIG.endpoints.suggestions}/${encodeURIComponent(input)}`);
            }
        }

        // 创建客户端实例
        const client = new WolframEnhancedClient();

        // UI函数
        function showLoading() {
            loadingContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '';
        }

        function hideLoading() {
            loadingContainer.classList.add('hidden');
        }

        function showError(title, message) {
            const errorHtml = `
                <div class="error-container">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle text-red-500 mr-3 mt-1 text-xl"></i>
                        <div class="flex-1">
                            <h3 class="font-semibold text-red-800 text-lg">${title}</h3>
                            <p class="text-red-700 mt-2">${message}</p>
                            <button onclick="retryLastQuery()" class="mt-3 px-4 py-2 bg-red-100 text-red-800 rounded-md hover:bg-red-200 transition-colors">
                                <i class="fas fa-redo mr-2"></i>重试
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.innerHTML = errorHtml;
        }

        function showWarning(message) {
            const warningHtml = `
                <div class="warning-container">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-3 mt-1 text-xl"></i>
                        <div>
                            <p class="text-yellow-800 font-medium">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.insertAdjacentHTML('beforeend', warningHtml);
        }

        function showTips(tips) {
            const tipsHtml = `
                <div class="tips-container">
                    <div class="flex items-start">
                        <i class="fas fa-lightbulb text-green-600 mr-3 mt-1 text-xl"></i>
                        <div>
                            <h3 class="font-semibold text-green-800 mb-3">建议</h3>
                            ${tips.map(tip => `<p class="text-green-700 mb-2">• ${tip}</p>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.insertAdjacentHTML('beforeend', tipsHtml);
        }

        // Pod渲染函数
        function getPodIcon(podId) {
            const iconMap = {
                'Input': 'keyboard',
                'Result': 'check-circle',
                'Solution': 'lightbulb',
                'Plot': 'chart-line',
                'Graph': 'project-diagram',
                'Table': 'table',
                'Formula': 'calculator',
                'Properties': 'list-ul',
                'Definition': 'book',
                'BasicInformation': 'info-circle',
                'AlternateForm': 'exchange-alt',
                'DecimalForm': 'hashtag',
                'NumberLine': 'ruler-horizontal',
                'Illustration': 'image',
                'ChemicalStructure': 'atom',
                'MolecularFormula': 'flask',
                'StepByStep': 'step-forward'
            };
            return iconMap[podId] || 'info-circle';
        }

        function renderPod(pod) {
            console.log('渲染Pod:', pod);
            
            if (!pod || typeof pod !== 'object') {
                console.error('无效的Pod数据:', pod);
                return '';
            }

            const isPrimary = pod.primary === true || pod.primary === 'true';
            const podId = pod.id || 'Unknown';
            const podTitle = pod.title || '未知标题';
            const icon = getPodIcon(podId);
            
            let content = '';
            
            // 处理子Pod
            if (pod.subpods && Array.isArray(pod.subpods) && pod.subpods.length > 0) {
                console.log(`Pod "${podTitle}" 有 ${pod.subpods.length} 个subpods`);
                
                pod.subpods.forEach((subpod, index) => {
                    console.log(`处理subpod ${index}:`, subpod);
                    
                    if (subpod.plaintext && subpod.plaintext.trim()) {
                        const text = subpod.plaintext.trim();
                        // 检查是否为数学表达式
                        if (text.includes('=') || text.includes('∫') || 
                            text.includes('∑') || text.includes('√') ||
                            text.includes('^') || text.includes('π') ||
                            text.includes('derivative') || text.includes('limit') ||
                            text.includes('∂') || text.includes('∞')) {
                            content += `<div class="math-display">${text}</div>`;
                        } else {
                            content += `<p class="mb-4 text-gray-800 leading-relaxed">${text}</p>`;
                        }
                    }
                    
                    // 处理图像
                    if (subpod.img) {
                        let imgSrc = '';
                        if (typeof subpod.img === 'string') {
                            imgSrc = subpod.img;
                        } else if (subpod.img.src) {
                            imgSrc = subpod.img.src;
                        }
                        
                        if (imgSrc) {
                            content += `
                                <div class="text-center">
                                    <img src="${imgSrc}" alt="${podTitle}" class="result-image mx-auto" 
                                         onerror="this.style.display='none'; console.log('图像加载失败:', this.src);">
                                </div>
                            `;
                        }
                    }
                });
            } else {
                console.log(`Pod "${podTitle}" 没有有效的subpods`);
                content += `<p class="text-gray-500 italic">此Pod没有可显示的内容</p>`;
            }

            // 处理states（如step-by-step）
            if (pod.states && Array.isArray(pod.states) && pod.states.length > 0) {
                content += `
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700 mb-3">可用选项：</p>
                        <div class="flex flex-wrap gap-2">
                `;
                pod.states.forEach(state => {
                    const stateName = state.name || state;
                    content += `
                        <button class="state-btn bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm hover:bg-blue-200 transition-colors" 
                                data-pod-id="${podId}" data-state="${stateName}">
                            <i class="fas fa-magic mr-1"></i>${stateName}
                        </button>
                    `;
                });
                content += `</div></div>`;
            }

            // 如果没有任何内容，添加调试信息
            if (!content.trim()) {
                content = `
                    <p class="text-gray-500 mb-2">Pod数据为空或无法解析</p>
                    <details class="bg-gray-100 p-3 rounded text-sm">
                        <summary class="cursor-pointer">查看原始Pod数据</summary>
                        <pre class="mt-2 overflow-auto">${JSON.stringify(pod, null, 2)}</pre>
                    </details>
                `;
            }

            const podHtml = `
                <div class="pod-container ${isPrimary ? 'pod-primary' : ''}">
                    <div class="pod-header">
                        <div class="flex items-center">
                            <i class="fas fa-${icon} mr-3 text-lg"></i>
                            <span class="text-lg">${podTitle}</span>
                            <span class="text-xs text-gray-500 ml-2">(${podId})</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${isPrimary ? '<span class="text-sm bg-orange-100 text-orange-800 px-3 py-1 rounded-full">主要结果</span>' : ''}
                            <button class="text-gray-400 hover:text-gray-600" onclick="togglePod(this)">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pod-content">
                        ${content}
                    </div>
                </div>
            `;

            return podHtml;
        }

        function renderAssumptions(assumptions) {
            if (!assumptions || assumptions.length === 0) return '';

            let assumptionsHtml = `
                <div class="assumption-container">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-question-circle text-yellow-600 mr-3 text-xl"></i>
                        <h3 class="text-lg font-semibold text-yellow-800">假设和解释</h3>
                    </div>
                    <p class="text-yellow-700 mb-4">Wolfram|Alpha对您的输入做出了以下假设，点击选择不同的解释：</p>
            `;

            assumptions.forEach(assumption => {
                if (assumption.values && assumption.values.length > 0) {
                    assumptionsHtml += `<div class="mb-4">`;
                    assumptionsHtml += `<p class="font-medium mb-3 text-yellow-800">${assumption.template || '选择解释'}</p>`;
                    
                    assumption.values.forEach(value => {
                        assumptionsHtml += `
                            <div class="assumption-item" onclick="reQueryWithAssumption('${value.input}')">
                                <div class="flex-1">
                                    <strong class="text-gray-800">${value.name}</strong>
                                    <p class="text-gray-600 text-sm mt-1">${value.desc}</p>
                                </div>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                            </div>
                        `;
                    });
                    assumptionsHtml += `</div>`;
                }
            });

            assumptionsHtml += `</div>`;
            return assumptionsHtml;
        }

        function renderStepByStep(pods) {
            const stepPods = pods.filter(pod => 
                pod.id.includes('Solution') || 
                pod.title.includes('Step') ||
                pod.title.includes('Solution')
            );

            if (stepPods.length === 0) return '';

            let stepHtml = `
                <div class="step-container">
                    <div class="flex items-center mb-6">
                        <i class="fas fa-step-forward text-blue-600 mr-3 text-xl"></i>
                        <h3 class="text-xl font-semibold text-blue-800">逐步解决方案</h3>
                    </div>
            `;

            stepPods.forEach((pod, podIndex) => {
                pod.subpods.forEach((subpod, stepIndex) => {
                    if (subpod.plaintext) {
                        stepHtml += `
                            <div class="step-item">
                                <div class="flex items-start">
                                    <div class="step-number">${podIndex * pod.subpods.length + stepIndex + 1}</div>
                                    <div class="flex-1">
                                        <h4 class="font-medium text-blue-800 mb-2">${pod.title}</h4>
                                        <div class="math-display bg-white border border-blue-200">
                                            ${subpod.plaintext}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            });

            stepHtml += `</div>`;
            return stepHtml;
        }

        // 主要查询函数
        async function executeQuery(input, options = {}) {
            if (!input.trim()) {
                showError('输入为空', '请输入您要查询的问题或表达式');
                return;
            }

            if (apiStatus !== 'online') {
                showError('API服务器离线', '请检查服务器状态或稍后重试');
                return;
            }

            currentQuery = input;
            showLoading();

            try {
                // 获取高级选项
                const advancedOptions = getAdvancedOptions();
                const queryOptions = { ...options, ...advancedOptions };

                let result;

                // 根据模式选择API端点
                if (document.getElementById('stepByStepMode').checked) {
                    result = await client.getStepByStep(input);
                } else if (document.getElementById('plotMode').checked) {
                    result = await client.getPlot(input, queryOptions.width);
                } else if (document.getElementById('validateMode').checked) {
                    result = await client.validateQuery(input);
                } else {
                    result = await client.query(input, queryOptions);
                }

                console.log('API响应:', result);
                processApiResponse(result);
                addToHistory(input);

            } catch (error) {
                console.error('查询错误:', error);
                showError('查询失败', error.message);
            } finally {
                hideLoading();
            }
        }

        function processApiResponse(response, appendMode = false) {
            console.log('处理API响应:', response, '追加模式:', appendMode);
            
            if (!response.success) {
                showError('查询失败', response.error || '未知错误');
                return;
            }

            const data = response.data;
            let resultsHtml = '';

            console.log('响应数据结构:', data);

            // 处理不同类型的响应数据结构
            let queryResult = null;
            
            // 检查多种可能的数据结构
            if (data && data.queryresult) {
                queryResult = data.queryresult;
            } else if (data && typeof data === 'object' && data.success !== undefined) {
                // 直接是queryresult格式
                queryResult = data;
            } else if (response.data && response.data.success !== undefined) {
                // 另一种可能的结构
                queryResult = response.data;
            }

            console.log('解析后的queryResult:', queryResult);

            if (!queryResult) {
                // 如果无法解析标准格式，显示原始数据用于调试
                resultsHtml = `
                    <div class="pod-container">
                        <div class="pod-header">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-3"></i>
                                <span>调试信息 - 原始响应数据</span>
                            </div>
                        </div>
                        <div class="pod-content">
                            <pre class="bg-gray-100 p-4 rounded-lg overflow-auto text-sm">${JSON.stringify(response, null, 2)}</pre>
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML = resultsHtml;
                return;
            }

            if (!queryResult.success) {
                if (queryResult.tips && queryResult.tips.length > 0) {
                    const tips = queryResult.tips.map(tip => tip.text || tip);
                    showTips(tips);
                    return;
                }
                if (queryResult.error) {
                    showError('查询未成功', queryResult.error.msg || queryResult.error);
                    return;
                }
                showError('查询未成功', '请尝试重新表述您的问题');
                return;
            }

            // 渲染assumptions
            if (queryResult.assumptions && queryResult.assumptions.length > 0) {
                resultsHtml += renderAssumptions(queryResult.assumptions);
            }

            // 检查是否为step-by-step模式
            if (document.getElementById('stepByStepMode').checked) {
                resultsHtml += renderStepByStep(queryResult.pods || []);
            }

            // 渲染pods
            if (queryResult.pods && queryResult.pods.length > 0) {
                console.log('渲染pods:', queryResult.pods.length, '个');
                queryResult.pods.forEach((pod, index) => {
                    console.log(`渲染Pod ${index}:`, pod);
                    resultsHtml += renderPod(pod);
                });
            } else {
                console.log('没有找到pods数据，numpods:', queryResult.numpods);
                
                // 如果没有pods，但查询成功，显示相关信息和建议
                resultsHtml += `
                    <div class="pod-container">
                        <div class="pod-header">
                            <div class="flex items-center">
                                <i class="fas fa-search mr-3"></i>
                                <span>查询结果</span>
                            </div>
                        </div>
                        <div class="pod-content">
                            <div class="mb-4">
                                <p class="text-gray-700 mb-2">查询 "<strong>${queryResult.inputstring || currentQuery}</strong>" 已被识别，但没有生成标准的Pod结果。</p>
                                <p class="text-gray-600 text-sm">这可能是因为查询过于简单或需要更具体的表述。</p>
                            </div>
                `;
                
                // 显示相关查询建议
                if (queryResult.relatedqueries && queryResult.relatedqueries.relatedquery) {
                    resultsHtml += `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-800 mb-3">相关查询建议：</h4>
                            <div class="space-y-2">
                    `;
                    
                    queryResult.relatedqueries.relatedquery.forEach(relatedQuery => {
                        resultsHtml += `
                            <button class="related-query-btn w-full text-left p-3 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors" 
                                    onclick="executeQueryWithAppend('${relatedQuery.replace(/'/g, "\\'")}')">
                                <i class="fas fa-plus text-blue-500 mr-2"></i>
                                <span class="text-blue-800">${relatedQuery}</span>
                                <span class="text-xs text-blue-600 ml-2">(追加结果)</span>
                            </button>
                        `;
                    });
                    
                    resultsHtml += `</div></div>`;
                }
                
                // 显示查询统计信息
                if (queryResult.timing || queryResult.datatypes) {
                    resultsHtml += `
                        <div class="bg-gray-50 p-3 rounded-lg mb-4">
                            <h5 class="font-medium text-gray-700 mb-2">查询信息：</h5>
                            <div class="text-sm text-gray-600 space-y-1">
                    `;
                    
                    if (queryResult.datatypes) {
                        resultsHtml += `<p><strong>数据类型:</strong> ${queryResult.datatypes}</p>`;
                    }
                    if (queryResult.timing) {
                        resultsHtml += `<p><strong>查询时间:</strong> ${queryResult.timing}秒</p>`;
                    }
                    if (queryResult.parsetiming) {
                        resultsHtml += `<p><strong>解析时间:</strong> ${queryResult.parsetiming}秒</p>`;
                    }
                    
                    resultsHtml += `</div></div>`;
                }
                
                resultsHtml += `
                            <details class="bg-gray-100 p-4 rounded-lg">
                                <summary class="cursor-pointer font-medium text-gray-700">查看完整响应数据</summary>
                                <pre class="mt-2 text-sm overflow-auto text-gray-600">${JSON.stringify(queryResult, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                `;
            }

            // 处理warnings
            if (queryResult.warnings && queryResult.warnings.length > 0) {
                queryResult.warnings.forEach(warning => {
                    showWarning(warning.text || warning);
                });
            }

            // 处理特殊响应类型
            if (response.type === 'step-by-step' && queryResult.pods) {
                resultsHtml += renderStepByStep(queryResult.pods);
            }

            console.log('最终HTML长度:', resultsHtml.length);
            
            if (resultsHtml.trim() === '') {
                resultsHtml = `
                    <div class="pod-container">
                        <div class="pod-header">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle mr-3"></i>
                                <span>无结果</span>
                            </div>
                        </div>
                        <div class="pod-content">
                            <p>查询成功但没有生成可显示的内容。请尝试其他查询。</p>
                        </div>
                    </div>
                `;
            }

            // 根据模式决定是覆盖还是追加结果
            if (appendMode) {
                // 追加模式：在现有结果后添加新内容
                const appendContainer = document.createElement('div');
                appendContainer.className = 'mt-6 pt-6 border-t border-gray-200';
                appendContainer.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                            补充信息
                        </h3>
                        <p class="text-sm text-gray-600">以下是相关的补充查询结果</p>
                    </div>
                    ${resultsHtml}
                `;
                resultsContainer.appendChild(appendContainer);
            } else {
                // 覆盖模式：替换所有内容
                resultsContainer.innerHTML = resultsHtml;
            }

            // 显示清除按钮（如果有结果内容）
            if (resultsHtml.trim() !== '' && !resultsHtml.includes('结果已清除')) {
                document.getElementById('clearBtn').classList.remove('hidden');
            }

            // 重新渲染MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset();
            }

            // 绑定state按钮事件
            document.querySelectorAll('.state-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const podId = this.dataset.podId;
                    const state = this.dataset.state;
                    reQueryWithState(podId, state);
                });
            });
        }

        function getAdvancedOptions() {
            const options = {};
            
            // 获取格式选项
            const formatRadio = document.querySelector('input[name="format"]:checked');
            if (formatRadio) {
                options.format = formatRadio.value;
            }

            // 获取单位系统
            const units = document.getElementById('unitsSelect').value;
            if (units) {
                options.units = units;
            }

            // 获取图像宽度
            const width = document.getElementById('widthSlider').value;
            if (width) {
                options.width = parseInt(width);
            }

            // 获取位置信息
            const location = document.getElementById('locationInput').value;
            if (location) {
                options.location = location;
            }

            return options;
        }

        // 重新查询函数
        function reQueryWithAssumption(assumptionInput) {
            executeQueryWithAppend(currentQuery, { assumption: assumptionInput });
        }

        function reQueryWithState(podId, state) {
            executeQueryWithAppend(currentQuery, { podstate: `${podId}__${state}` });
        }

        // 追加模式的查询函数
        async function executeQueryWithAppend(input, options = {}) {
            if (!input.trim()) {
                showError('输入为空', '请输入您要查询的问题或表达式');
                return;
            }

            if (apiStatus !== 'online') {
                showError('API服务器离线', '请检查服务器状态或稍后重试');
                return;
            }

            // 显示加载状态（但不清除现有结果）
            const loadingElement = document.createElement('div');
            loadingElement.className = 'mt-6 pt-6 border-t border-gray-200 text-center py-8';
            loadingElement.innerHTML = `
                <div class="loading-animation mx-auto mb-4"></div>
                <p class="text-gray-600">正在获取补充信息...</p>
            `;
            resultsContainer.appendChild(loadingElement);

            try {
                // 获取高级选项
                const advancedOptions = getAdvancedOptions();
                const queryOptions = { ...options, ...advancedOptions };

                let result;

                // 根据模式选择API端点
                if (document.getElementById('stepByStepMode').checked) {
                    result = await client.getStepByStep(input);
                } else if (document.getElementById('plotMode').checked) {
                    result = await client.getPlot(input, queryOptions.width);
                } else if (document.getElementById('validateMode').checked) {
                    result = await client.validateQuery(input);
                } else {
                    result = await client.query(input, queryOptions);
                }

                console.log('追加查询API响应:', result);
                
                // 移除加载元素
                loadingElement.remove();
                
                // 使用追加模式处理响应
                processApiResponse(result, true);

            } catch (error) {
                console.error('追加查询错误:', error);
                loadingElement.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        获取补充信息失败: ${error.message}
                    </div>
                `;
            }
        }

        function retryLastQuery() {
            if (currentQuery) {
                executeQuery(currentQuery);
            }
        }

        // 历史记录管理
        function addToHistory(query) {
            const historyItem = {
                query: query,
                timestamp: new Date().toISOString(),
                type: getQueryType()
            };
            
            // 避免重复
            queryHistory = queryHistory.filter(item => item.query !== query);
            queryHistory.unshift(historyItem);
            
            // 限制历史记录数量
            if (queryHistory.length > 100) {
                queryHistory = queryHistory.slice(0, 100);
            }
            
            localStorage.setItem('wolframHistoryEnhanced', JSON.stringify(queryHistory));
            updateHistoryDisplay();
        }

        function getQueryType() {
            if (document.getElementById('stepByStepMode').checked) return 'step-by-step';
            if (document.getElementById('plotMode').checked) return 'plot';
            if (document.getElementById('validateMode').checked) return 'validate';
            return 'query';
        }

        function updateHistoryDisplay() {
            historyList.innerHTML = '';
            
            if (queryHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">暂无查询历史</p>
                    </div>
                `;
                return;
            }

            queryHistory.forEach(item => {
                const date = new Date(item.timestamp).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const typeIcon = {
                    'query': 'search',
                    'step-by-step': 'step-forward',
                    'plot': 'chart-line',
                    'validate': 'check-circle'
                }[item.type] || 'search';

                const historyItemHtml = `
                    <div class="history-item" onclick="executeQuery('${item.query.replace(/'/g, "\\'")}')">
                        <i class="fas fa-${typeIcon} text-gray-400 mr-3"></i>
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${item.query}</p>
                            <p class="text-sm text-gray-500">${date} • ${item.type}</p>
                        </div>
                        <i class="fas fa-arrow-right text-gray-300"></i>
                    </div>
                `;
                historyList.insertAdjacentHTML('beforeend', historyItemHtml);
            });
        }

        // 搜索建议
        async function showSuggestions(query) {
            if (query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }

            try {
                const result = await client.getSuggestions(query);
                if (result.success && result.suggestions) {
                    suggestionsList.innerHTML = '';
                    result.suggestions.forEach(suggestion => {
                        const suggestionHtml = `
                            <div class="suggestion-item" onclick="executeQuery('${suggestion}')">
                                <i class="fas fa-search text-gray-400 mr-3"></i>
                                <span>${suggestion}</span>
                            </div>
                        `;
                        suggestionsList.insertAdjacentHTML('beforeend', suggestionHtml);
                    });
                    suggestions.classList.remove('hidden');
                }
            } catch (error) {
                console.error('获取建议失败:', error);
            }
        }

        // Pod折叠功能
        function togglePod(button) {
            const pod = button.closest('.pod-container');
            const content = pod.querySelector('.pod-content');
            const icon = button.querySelector('i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // 事件监听器
        searchBtn.addEventListener('click', () => {
            executeQuery(queryInput.value);
            suggestions.classList.add('hidden');
        });

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                executeQuery(queryInput.value);
                suggestions.classList.add('hidden');
            }
        });

        // 清除按钮事件
        document.getElementById('clearBtn').addEventListener('click', () => {
            // 清除所有结果
            resultsContainer.innerHTML = `
                <div class="text-center py-16">
                    <div class="mb-8">
                        <i class="fas fa-broom text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">结果已清除</h3>
                        <p class="text-gray-500">输入新的查询开始计算</p>
                    </div>
                </div>
            `;
            
            // 隐藏清除按钮
            document.getElementById('clearBtn').classList.add('hidden');
            
            // 清空输入框
            queryInput.value = '';
            queryInput.focus();
        });

        queryInput.addEventListener('input', (e) => {
            showSuggestions(e.target.value);
        });

        queryInput.addEventListener('focus', () => {
            if (queryInput.value.length >= 2) {
                showSuggestions(queryInput.value);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestions.classList.add('hidden');
            }
        });

        // 示例按钮
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const query = btn.dataset.query;
                const mode = btn.dataset.mode;
                
                queryInput.value = query;
                
                // 重置所有模式
                document.getElementById('stepByStepMode').checked = false;
                document.getElementById('plotMode').checked = false;
                document.getElementById('validateMode').checked = false;
                
                // 设置对应模式
                if (mode === 'stepbystep') {
                    document.getElementById('stepByStepMode').checked = true;
                } else if (mode === 'plot') {
                    document.getElementById('plotMode').checked = true;
                } else if (mode === 'validate') {
                    document.getElementById('validateMode').checked = true;
                }
                
                console.log(`执行示例查询: "${query}", 模式: ${mode}`);
                executeQuery(query);
            });
        });

        // 模态框事件
        document.getElementById('historyBtn').addEventListener('click', () => {
            updateHistoryDisplay();
            historyModal.classList.remove('hidden');
        });

        document.getElementById('closeHistoryModal').addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        document.getElementById('advancedOptionsBtn').addEventListener('click', () => {
            advancedModal.classList.remove('hidden');
        });

        document.getElementById('closeAdvancedModal').addEventListener('click', () => {
            advancedModal.classList.add('hidden');
        });

        // 高级选项
        document.getElementById('widthSlider').addEventListener('input', (e) => {
            document.getElementById('widthValue').textContent = e.target.value;
        });

        document.getElementById('resetAdvanced').addEventListener('click', () => {
            document.querySelector('input[name="format"][value="plaintext,image"]').checked = true;
            document.getElementById('unitsSelect').value = '';
            document.getElementById('widthSlider').value = 400;
            document.getElementById('widthValue').textContent = '400';
            document.getElementById('locationInput').value = '';
        });

        document.getElementById('applyAdvanced').addEventListener('click', () => {
            advancedModal.classList.add('hidden');
        });

        // 点击模态框外部关闭
        [historyModal, advancedModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                queryInput.focus();
            }
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                document.getElementById('historyBtn').click();
            }
            if (e.key === 'Escape') {
                suggestions.classList.add('hidden');
                historyModal.classList.add('hidden');
                advancedModal.classList.add('hidden');
            }
        });

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Wolfram|Alpha Enhanced Client 已加载');
            queryInput.focus();
        });
    </script>
</body>
</html>

